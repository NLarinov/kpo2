# Микросервисная система проверки студенческих работ

![CI](https://github.com/NLarinov/kpo2/workflows/CI%20-%20Build%20and%20Test/badge.svg)
![Docker Build](https://github.com/NLarinov/kpo2/workflows/Docker%20Build%20and%20Test/badge.svg)

## Описание

Система для приема, хранения и анализа студенческих работ с автоматическим определением плагиата и генерацией облака слов.

## Архитектура

Система состоит из трех основных микросервисов:

### 1. File Storing Service
**Порт:** 5001  
**Ответственность:**
- Прием и хранение файлов студенческих работ
- Сохранение метаданных о сдаче (студент, задание, время сдачи)
- Вычисление хеша файла для определения плагиата
- Выдача файлов по запросу
- Автоматический запуск анализа после сохранения файла

**API Endpoints:**
- `POST /api/filestorage/submit` - Загрузка работы (multipart/form-data: file, studentName, assignmentId)
- `GET /api/filestorage/{id}` - Получение информации о сдаче
- `GET /api/filestorage/{id}/file` - Скачивание файла
- `GET /api/filestorage/assignment/{assignmentId}` - Получение всех сдач по заданию

### 2. File Analysis Service
**Порт:** 5002  
**Ответственность:**
- Анализ загруженных файлов
- Определение плагиата путем сравнения хешей файлов
- Генерация отчетов об анализе
- Создание облака слов для визуализации работы
- Хранение результатов анализа

**API Endpoints:**
- `POST /api/analysis/start` - Запуск анализа (body: WorkSubmissionId, FileHash, AssignmentId)
- `GET /api/analysis/report/{reportId}` - Получение отчета
- `GET /api/analysis/works/{workId}/reports` - Получение всех отчетов по работе
- `GET /api/analysis/report/{reportId}/wordcloud` - Получение URL облака слов

### 3. API Gateway
**Порт:** 5000  
**Ответственность:**
- Единая точка входа для всех клиентских запросов
- Маршрутизация запросов к соответствующим микросервисам
- Обеспечение единообразного API

**Маршруты:**
- `/api/filestorage/*` File Storing Service
- `/api/analysis/*` File Analysis Service

## Алгоритм определения плагиата

Система определяет плагиат следующим образом:

1. **Вычисление хеша файла:** При загрузке файла вычисляется SHA-256 хеш его содержимого
2. **Сравнение хешей:** При анализе работы система запрашивает все сдачи по данному заданию из File Storing Service
3. **Проверка на совпадение:** Если найден файл с таким же хешем, сданный ранее другим студентом, система помечает работу как плагиат
4. **Формирование отчета:** В отчете указывается информация о первой найденной работе с таким же содержимым (имя студента, дата сдачи)

## Технологический стек

- **.NET 8.0** - платформа разработки
- **ASP.NET Core** - веб-фреймворк
- **Entity Framework Core** - ORM (InMemory для упрощения)
- **Ocelot** - API Gateway
- **Docker** - контейнеризация
- **xUnit** - фреймворк для тестирования
- **Moq** - мокирование для тестов
- **QuickChart.io** - генерация облака слов

## Запуск системы

### Требования
- Docker и Docker Compose
- .NET 8.0 SDK (для локальной разработки)

### Запуск через Docker Compose

```bash
docker compose up --build
```

Система будет доступна по следующим адресам:
- API Gateway: http://localhost:5000
- File Storing Service: http://localhost:5001
- File Analysis Service: http://localhost:5002

### Swagger документация

После запуска доступна по адресам:
- API Gateway: http://localhost:5000/swagger
- File Storing Service: http://localhost:5001/swagger
- File Analysis Service: http://localhost:5002/swagger

## Пользовательские сценарии

### Сценарий 1: Студент сдает работу

1. **Клиент** отправляет POST запрос на `/api/filestorage/submit` через API Gateway
2. **API Gateway** маршрутизирует запрос в **File Storing Service**
3. **File Storing Service**:
   - Сохраняет файл на диск
   - Вычисляет SHA-256 хеш файла
   - Сохраняет метаданные в БД (студент, задание, время, хеш)
   - Возвращает информацию о сохраненной работе
4. **File Storing Service** асинхронно отправляет HTTP запрос в **File Analysis Service** для запуска анализа
5. **File Analysis Service** создает задачу анализа и начинает обработку в фоновом режиме

### Сценарий 2: Анализ работы и определение плагиата

1. **File Analysis Service** получает запрос на анализ от File Storing Service
2. Система запрашивает все сдачи по данному заданию из **File Storing Service** через HTTP
3. Сравнивает хеш текущей работы с хешами ранее сданных работ
4. Если найден совпадающий хеш:
   - Помечает работу как плагиат
   - Сохраняет информацию о первой найденной работе с таким же содержимым
5. Извлекает текст из файла (если возможно) и анализирует частоту слов
6. Сохраняет отчет в БД и на диск
7. Обновляет статус анализа на "Completed"

### Сценарий 3: Преподаватель запрашивает аналитику

1. **Клиент** отправляет GET запрос на `/api/analysis/works/{workId}/reports` через API Gateway
2. **API Gateway** маршрутизирует запрос в **File Analysis Service**
3. **File Analysis Service**:
   - Находит все отчеты по указанной работе
   - Формирует ответ со статусами и флагами плагиата
   - Возвращает JSON с информацией о всех отчетах

### Сценарий 4: Получение облака слов

1. **Клиент** отправляет GET запрос на `/api/analysis/report/{reportId}/wordcloud` через API Gateway
2. **API Gateway** маршрутизирует запрос в **File Analysis Service**
3. **File Analysis Service**:
   - Получает отчет с данными о частоте слов
   - Формирует URL для QuickChart API с данными о частоте слов
   - Возвращает URL облака слов

## Обработка ошибок

Система обрабатывает следующие сценарии ошибок:

1. **Падение одного из микросервисов:**
   - API Gateway возвращает ошибку 503 (Service Unavailable) при недоступности микросервиса
   - Клиент получает понятное сообщение об ошибке

2. **Ошибки валидации:**
   - Все сервисы проверяют входные данные
   - Возвращаются ошибки 400 (Bad Request) с описанием проблемы

3. **Ошибки при анализе:**
   - Если анализ не удался, статус отчета устанавливается в "Failed"
   - Информация об ошибке логируется

## Тестирование

Запуск тестов:
```bash
dotnet test
```

Тесты покрывают:
- Сохранение и получение файлов
- Создание и получение отчетов анализа
- Фильтрацию по заданиям
- Обработку ошибок

## CI/CD

Проект использует GitHub Actions для автоматической проверки кода:

### CI - Build and Test
- Автоматический запуск тестов при push и pull request
- Проверка сборки всех проектов
- Публикация результатов тестирования
- Кэширование NuGet пакетов для ускорения сборки

### Docker Build
- Автоматическая сборка Docker образов при изменении Dockerfile
- Проверка корректности конфигурации Docker
- Кэширование слоев Docker для оптимизации сборки

Workflow файлы находятся в `.github/workflows/`
